name: CD - Continuous Deployment

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  REGISTRY_NAME: 'fgcregistry'
  IMAGE_NAME: 'fgc-users-api'

jobs:
  deploy:
    name: ðŸš€ Deploy to Azure
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ðŸ“¦ Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: ðŸ”„ Restore Dependencies
      run: dotnet restore
    
    - name: ðŸ—ï¸ Build Solution
      run: dotnet build --configuration Release --no-restore
    
    - name: ðŸ§ª Run Tests
      run: dotnet test --configuration Release --no-build
    
    - name: ðŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ðŸ³ Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.REGISTRY_NAME }}
    
    - name: ðŸ·ï¸ Generate Image Tags
      id: meta
      run: |
        echo "IMAGE_TAG=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        echo "LATEST_TAG=latest" >> $GITHUB_OUTPUT
        echo "FULL_IMAGE_NAME=${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
    
    - name: ðŸ³ Build and Push Docker Image
      run: |
        docker build -t ${{ steps.meta.outputs.FULL_IMAGE_NAME }}:${{ steps.meta.outputs.IMAGE_TAG }} .
        docker build -t ${{ steps.meta.outputs.FULL_IMAGE_NAME }}:${{ steps.meta.outputs.LATEST_TAG }} .
        docker push ${{ steps.meta.outputs.FULL_IMAGE_NAME }}:${{ steps.meta.outputs.IMAGE_TAG }}
        docker push ${{ steps.meta.outputs.FULL_IMAGE_NAME }}:${{ steps.meta.outputs.LATEST_TAG }}
    
    - name: ðŸš€ Deploy to Azure Container Instance
      run: |
        az container create \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name fgc-users-container \
          --image ${{ steps.meta.outputs.FULL_IMAGE_NAME }}:${{ steps.meta.outputs.IMAGE_TAG }} \
          --registry-login-server ${{ env.REGISTRY_NAME }}.azurecr.io \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }} \
          --dns-name-label fgc-users-api \
          --os-type Linux \
          --ports 8080 \
          --cpu 1 \
          --memory 1.5 \
          --restart-policy Always \
          --environment-variables \
            ASPNETCORE_ENVIRONMENT=Production \
            ASPNETCORE_URLS=http://+:8080 \
            ConnectionStrings__DefaultConnection="${{ secrets.CONNECTION_STRING }}" \
            Jwt__SecretKey="${{ secrets.JWT_SECRET_KEY }}" \
            Jwt__Issuer=FGC.Users.API \
            Jwt__Audience=FGC.Client \
            Jwt__ExpireMinutes=120
    
    - name: ðŸ“Š Get Deployment Info
      id: deployment-info
      run: |
        FQDN=$(az container show \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name fgc-users-container \
          --query ipAddress.fqdn -o tsv)
        echo "FQDN=${FQDN}" >> $GITHUB_OUTPUT
        echo "URL=http://${FQDN}:8080" >> $GITHUB_OUTPUT
    
    - name: ðŸ¥ Health Check
      run: |
        echo "Waiting for application to start..."
        sleep 60
        curl -f ${{ steps.deployment-info.outputs.URL }}/health || echo "Health check pending"
    
    - name: ðŸ“ Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Service**: FGC Users API" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "**Image**: ${{ steps.meta.outputs.FULL_IMAGE_NAME }}:${{ steps.meta.outputs.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL**: ${{ steps.deployment-info.outputs.URL }}" >> $GITHUB_STEP_SUMMARY
        echo "**Health**: ${{ steps.deployment-info.outputs.URL }}/health" >> $GITHUB_STEP_SUMMARY